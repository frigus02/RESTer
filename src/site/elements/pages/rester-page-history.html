<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">

<link rel="import" href="../styles/rester-icons.html">
<link rel="import" href="../styles/rester-page-styles.html">
<link rel="import" href="../styles/rester-paper-item-button.html">

<dom-module id="rester-page-history">
    <template>
        <style include="rester-page-styles rester-paper-item-button">
            :host {
                display: block;
            }

            paper-item {
                margin: 8px 0;
            }

            paper-spinner {
                display: block;
                margin: 0 auto;
            }

            .button-container {
                text-align: center;
            }

            .button-container paper-button {
                background: var(--primary-color);
                color: var(--light-theme-text-color);
            }

			.method {
				text-align: center;
				width: 90px;
			}
			.method-DEL, .method-DELETE {
				background-color: red;
			}
			.method-GET {
				background-color: #2392f7;
			}
			.method-POST {
				background-color: #13c20f;
				color: black;
			}
			.method-PUT, .method-PATCH {
				background-color: #ff9000;
				color: black;
			}
			.method-HEAD, .method-OPT, .method-OPTIONS {
				background-color: #ccc;
				color: black;
			}

			.status-200, .status-204 {
				color: #0c0;
			}
			.status-400, .status-401, .status-403, .status-404, .status-405, .status-413, .status-414, .status-415 {
				color: red;
			}
			.status-422, .status-500, .status-501, .status-502, .status-504 {
				color: red;
			}
        </style>

        <app-header-layout>
            <app-header slot="header" fixed shadow>
                <app-toolbar>
                    <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
                    <div main-title>[[pageTitle]]</div>
                </app-toolbar>
            </app-header>
            <div role="main">
                <template is="dom-repeat" items="[[historyEntries]]">
                    <paper-item class="button">
                        <paper-item-body
                                two-line$="[[!item.request.id]]"
                                three-line$="[[item.request.id]]"
                                on-tap="_openHistoryEntry">
                            <paper-ripple></paper-ripple>
                            <div>[[item.timeFormatted]]</div>
                            <template is="dom-if" if="[[item.request.id]]">
                                <div secondary>[[item.request.collection]] / [[item.request.title]]</div>
                            </template>
                            <div secondary>
                                <font class$="method method-[[item.request.methodCompiled]]" slot="item-icon">[[item.request.methodCompiled]]</font>
                                [[item.request.urlCompiled]]<br>
                                <font class$="status-[[item.response.status]]">[[item.response.status]]</font>
                                [[item.response.statusText]]
                            </div>
                        </paper-item-body>
                        <paper-icon-button
                                icon="delete"
                                alt="Delete history entry"
                                on-tap="_deleteHistoryEntry"></paper-icon-button>
                    </paper-item>
                </template>
                <div hidden$="[[!loading]]">
                    <paper-spinner active></paper-spinner>
                </div>
                <div class="button-container" hidden$="[[loading]]">
                    <paper-button
                            raised
                            on-tap="loadAll"
                            hidden$="[[!moreEntriesAvailable]]">
                        Load all (this may take a while)
                    </paper-button>
                </div>
            </div>
        </app-header-layout>
    </template>

    <script>
        import { dateTime } from '../data/scripts/format.js';
        import { getHistoryEntries, deleteHistoryEntries } from '../data/scripts/rester.js';
        import { replaceWithoutProvidedValues } from '../data/scripts/variables.js';
        import RESTerPageMixin from '../layout/rester-page-mixin.js';

        /**
         * @appliesMixin RESTerPageMixin
         * @polymer
         * @customElement
         */
        class RESTerPageHistory extends RESTerPageMixin(Polymer.Element) {
            static get is() {
                return 'rester-page-history';
            }

            static get properties() {
                return {
                    historyEntries: {
                        type: Array,
                        readOnly: true
                    },
                    moreEntriesAvailable: {
                        type: Boolean,
                        computed: '_computeMoreEntriesAvailable(historyEntries.length)'
                    },
                    loading: {
                        type: Boolean,
                        readOnly: true
                    }
                };
            }

            static get historyFields() {
                return ['id', 'time', 'request.id', 'request.collection', 'request.title', 'request.method', 'request.url', 'request.variables', 'response.status', 'response.statusText'];
            }

            static get initialCount() {
                return 25;
            }

            ready() {
                super.ready();
                this._setPageTitle('History');
                this._load(RESTerPageHistory.initialCount);
            }

            loadAll() {
                this._load(null);
            }

            _load(count) {
                this._setLoading(true);
                getHistoryEntries(count, RESTerPageHistory.historyFields).then(entries => {
                    this._setLoading(false);
                    this._setHistoryEntries(entries.map(e => {
                        e.timeFormatted = dateTime(e.time);

                        const compiledRequest = replaceWithoutProvidedValues(e.request, e.request.variables.values);

                        e.request.methodCompiled = compiledRequest.method;
                        e.request.urlCompiled = compiledRequest.url;

                        return e;
                    }));
                });
            }

            _computeMoreEntriesAvailable() {
                return this.historyEntries.length === RESTerPageHistory.initialCount;
            }

            _openHistoryEntry(e) {
                const entry = e.model.item;
                window.location = `#/request/${entry.request.id || ''}/history/${entry.id}`;
            }

            _deleteHistoryEntry(e) {
                const entry = e.model.item;
                deleteHistoryEntries(entry.id).then(() => {
                    const index = this.historyEntries.indexOf(entry);
                    this.splice('historyEntries', index, 1);
                });
            }
        }

        customElements.define(RESTerPageHistory.is, RESTerPageHistory);
    </script>
</dom-module>
